import { Injectable } from '@angular/core';
import { fromEvent } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable({
  providedIn: 'root'
})
export class RegistrationToolService {
  private inputBuffer: string = '';
  private lastTimestamp: number | null = null;
  private readonly speedThreshold = 30; // Threshold in ms to detect scanner input
  private readonly minScannerLength = 5; // Minimum length to consider input as scanner input

  constructor() {
    this.startListening();
  }

  private startListening() {
    fromEvent<KeyboardEvent>(document, 'keydown')
      .pipe(
        map(event => ({
          key: event.key,
          timestamp: event.timeStamp
        }))
      )
      .subscribe(event => this.handleKey(event));
  }

  private handleKey(event: { key: string; timestamp: number }) {
    if (event.key === 'Enter') {
      // When Enter is pressed, finalize and process the input
      this.finalizeInput(this.inputBuffer);
      this.inputBuffer = ''; // Reset the buffer for the next input sequence
      this.lastTimestamp = null; // Reset the timestamp
    } else {
      if (this.lastTimestamp) {
        const timeDifference = event.timestamp - this.lastTimestamp;

        if (timeDifference < this.speedThreshold) {
          // If the time difference is within the speed threshold, it's likely scanner input
          this.inputBuffer += event.key;
        } else {
          // If the time difference is too large, reset the buffer (potential new input)
          this.inputBuffer = event.key;
        }
      } else {
        // First key press in the sequence, start the buffer
        this.inputBuffer += event.key;
      }

      this.lastTimestamp = event.timestamp; // Update the last timestamp
    }
  }

  private finalizeInput(input: string) {
    if (this.isScannerInput(input)) {
      console.log('Scanner input detected:', input);
      this.processScannerInput(input);
    } else {
      console.log('Ignored non-scanner input:', input);
      // Optionally log or ignore this input
    }
  }

  private isScannerInput(input: string): boolean {
    // If the input is shorter than expected for a scanner, consider it a human input
    return input.length >= this.minScannerLength;
  }

  private processScannerInput(input: string) {
    // Add your scanner input processing logic here
    console.log('Processing scanner input:', input);
  }
}